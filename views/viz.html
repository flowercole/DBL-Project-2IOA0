<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Visualization</title>
    <style>
        #wrapper {
        position:relative;
        }

        #app {
            margin-top: 20px;
            position:absolute;
            height: 90%;
            width: 90%;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div class="wrapper">
        <select name="vislist" id="select-viz" form="vis">
            <option value="">Select one of the following Visualizations</option>
            <option value="matrix">Matrix</option>
            <option value="graph">Graph</option>
        </select>
        <select name="vislist" id="select-data" form="vis">
            <option value="">Select one of the following datasets</option>
        </select>
        <button id="update-btn">Visualise!</button>

        <div id="app" style="background-color:#666;">



            <h1 style="color:antiquewhite; margin: 0 auto;">Select a visualization above and a dataset to begin</h1>
        </div>
    </div>

    <script>
    let selectData = document.querySelector('#select-data');
    let selectViz = document.querySelector('#select-viz');
    var updateBtn = document.getElementById('update-btn')

    window.onload = () => {
        let files = [];
        fetch('http://localhost:3000/datasets')
        .then((resp) => resp.json()) // Transform the data into json
        .then(function(res) {
            files = files.concat(res.data);
            //check localStorage
            if(localStorage.getItem('file_name')!= null){
                files.push(localStorage.getItem('file_name').replace(/['"]+/g, ''));
            }
            // Remove duplicates
            files = [...new Set(files)];
            updateSelect(files);
        })
        .catch(function(err) {
            console.log(err);
            // This is where you run code if the server returns any errors
        });
    }

    updateSelect = (data) => {
        let files = data;
        files.forEach((file) => {
            let opt = document.createElement('option');
            opt.value = file;
            opt.dataset.local = false; //TODO make this true for localStorage files
            opt.innerHTML = file;

            selectData.appendChild(opt);
        })
    }

    selectData.addEventListener('change', (event) => {
        const result = document.querySelector('.result');
        // TODO make fetch for the given file
        console.log(`You chose ${event.target.value}`);

        localStorage.setItem('selected_file', `${event.target.value}`)

    });

    selectViz.addEventListener('change', (event) => {
        // Logic to fetch data
        console.log(`You chose ${event.target.value}`);
        localStorage.setItem('selected_vis', `${event.target.value}`)

        let div = document.getElementById("app");

        switch(event.target.value){
            case 'matrix':
            div.removeAttribute("style");
            while (div.firstChild) {
              div.removeChild(div.firstChild);
            }
                loadMatrixPage();
                break;
            case 'graph':
              div.removeAttribute("style");
              while (div.firstChild) {
                div.removeChild(div.firstChild);
              }
                loadForceGraphPage();
                break;
            default:
                break;
        }

        // Check if the data select has any value, otherwise default to the first one:
        // if(selectData.options[selectData.selectedIndex].value == ''){
        //     selectData.selectedIndex = 1;
        // }

        // TODO fetch visualization file
    });

    updateBtn.addEventListener('click', (event) => {
      var file = localStorage.getItem('selected_file')
      var vis = localStorage.getItem('selected_vis')

      console.log('Updating the VISUALIZATION...');


      switch(vis){
          case 'matrix':
              loadMatrix();
              break;
          case 'graph':
              loadForceGraph();
              break;
          default:
              break;
      }
    })

    loadMatrixPage = () => {
      fetch('/comp/matrix.html')
      .then(function(response) {
        response.text().then(function (text) {
          // do something with the text response
          document.getElementById("app").innerHTML=text;
        });
        // console.log(response.body)
        return response;
      });
    }

    loadForceGraphPage = () => {
      fetch('/comp/graph.html')
      .then(function(response) {
        response.text().then(function (text) {
          // do something with the text response
          document.getElementById("app").innerHTML=text;
        });
        // console.log(response.body)
        return response;
      });
    }


    </script>

    <!-- include components -->
    <script src="/public/scripts/matrix.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="/public/scripts/graph.js"></script>


</body>
</html>
